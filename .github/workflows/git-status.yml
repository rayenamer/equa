name: Update Git Stats

on:
  # Run on push to main
  push:
    branches:
      - main

  # Also run weekly to keep stats fresh
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    name: Generate Git Statistics

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for accurate stats

      - name: Generate Git Stats
        id: stats
        run: |
          echo "# ðŸ“Š Repository Statistics" > CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          echo "*Last updated: $(date '+%Y-%m-%d %H:%M:%S UTC')*" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          
          # Top Contributors by Commits
          echo "## ðŸ† Top Contributors" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          echo "| Rank | Contributor | Commits | Lines Added | Lines Removed |" >> CONTRIBUTORS.md
          echo "|------|-------------|---------|-------------|---------------|" >> CONTRIBUTORS.md
          
          git log --all --format='%aN' | sort | uniq | while read author; do
            commits=$(git log --all --author="$author" --oneline | wc -l)
            additions=$(git log --all --author="$author" --numstat | awk '{add+=$1} END {print add}')
            deletions=$(git log --all --author="$author" --numstat | awk '{del+=$2} END {print del}')
          
            # Handle empty values
            additions=${additions:-0}
            deletions=${deletions:-0}
          
            echo "$commits|$author|$additions|$deletions"
          done | sort -rn -t'|' -k1 | head -10 | awk -F'|' '{printf "| %d | %s | %s | %s | %s |\n", NR, $2, $1, $3, $4}' >> CONTRIBUTORS.md
          
          echo "" >> CONTRIBUTORS.md
          
          # Most Changed Files
          echo "## ðŸ“ Most Changed Files" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          echo "| File | Changes | Contributors |" >> CONTRIBUTORS.md
          echo "|------|---------|--------------|" >> CONTRIBUTORS.md
          
          git log --all --name-only --format="" | grep -v '^$' | sort | uniq -c | sort -rn | head -15 | while read count file; do
            contributors=$(git log --all --follow --format='%aN' -- "$file" | sort | uniq | wc -l)
            echo "| \`$file\` | $count | $contributors |"
          done >> CONTRIBUTORS.md
          
          echo "" >> CONTRIBUTORS.md
          
          # Language Breakdown
          echo "## ðŸ’» Code Statistics" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          
          total_commits=$(git rev-list --all --count)
          total_files=$(git ls-files | wc -l)
          total_lines=$(git ls-files | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}')
          
          echo "- **Total Commits:** $total_commits" >> CONTRIBUTORS.md
          echo "- **Total Files:** $total_files" >> CONTRIBUTORS.md
          echo "- **Total Lines of Code:** $total_lines" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          
          # Recent Activity
          echo "## ðŸ”¥ Recent Activity (Last 30 Days)" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          
          since_date=$(date -d '30 days ago' '+%Y-%m-%d' 2>/dev/null || date -v-30d '+%Y-%m-%d')
          recent_commits=$(git log --all --since="$since_date" --oneline | wc -l)
          recent_contributors=$(git log --all --since="$since_date" --format='%aN' | sort | uniq | wc -l)
          
          echo "- **Commits:** $recent_commits" >> CONTRIBUTORS.md
          echo "- **Active Contributors:** $recent_contributors" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          
          # Top Contributors in Last 30 Days
          echo "### Most Active Contributors (Last 30 Days)" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          echo "| Contributor | Commits |" >> CONTRIBUTORS.md
          echo "|-------------|---------|" >> CONTRIBUTORS.md
          
          git log --all --since="$since_date" --format='%aN' | sort | uniq -c | sort -rn | head -5 | awk '{printf "| %s | %d |\n", substr($0, index($0,$2)), $1}' >> CONTRIBUTORS.md
          
          echo "" >> CONTRIBUTORS.md
          
          # Contribution Graph (ASCII art)
          echo "## ðŸ“ˆ Commit Activity (Last 12 Weeks)" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          echo "\`\`\`" >> CONTRIBUTORS.md
          
          for i in {11..0}; do
            week_start=$(date -d "$((i*7)) days ago" '+%Y-%m-%d' 2>/dev/null || date -v-$((i*7))d '+%Y-%m-%d')
            week_end=$(date -d "$(((i-1)*7)) days ago" '+%Y-%m-%d' 2>/dev/null || date -v-$(((i-1)*7))d '+%Y-%m-%d')
            commits=$(git log --all --since="$week_start" --until="$week_end" --oneline | wc -l)
          
            # Create bar chart
            bar=$(printf 'â–ˆ%.0s' $(seq 1 $((commits > 50 ? 50 : commits))))
            printf "Week %2d: %-50s %d commits\n" $((12-i)) "$bar" $commits
          done >> CONTRIBUTORS.md
          
          echo "\`\`\`" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          
          # Fun Facts
          echo "## ðŸŽ¯ Fun Facts" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          
          first_commit_date=$(git log --all --reverse --format='%ai' | head -1 | cut -d' ' -f1)
          days_active=$(( ($(date +%s) - $(date -d "$first_commit_date" +%s 2>/dev/null || date -j -f "%Y-%m-%d" "$first_commit_date" +%s)) / 86400 ))
          avg_commits_per_day=$(echo "scale=2; $total_commits / $days_active" | bc)
          
          busiest_day=$(git log --all --format='%cd' --date=format:'%A' | sort | uniq -c | sort -rn | head -1 | awk '{print $2}')
          busiest_hour=$(git log --all --format='%cd' --date=format:'%H' | sort | uniq -c | sort -rn | head -1 | awk '{print $2":00"}')
          
          echo "- **Repository Age:** $days_active days" >> CONTRIBUTORS.md
          echo "- **Average Commits/Day:** $avg_commits_per_day" >> CONTRIBUTORS.md
          echo "- **Most Active Day:** $busiest_day" >> CONTRIBUTORS.md
          echo "- **Most Active Hour:** $busiest_hour" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          
          echo "---" >> CONTRIBUTORS.md
          echo "*Generated by [Git Stats Action](https://github.com/${{ github.repository }}/actions)*" >> CONTRIBUTORS.md

      - name: Commit and Push to Stats Branch
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Switch to stats branch (create if doesn't exist)
          git checkout -B stats
          
          git add CONTRIBUTORS.md
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Update git statistics [skip ci]"
            git push origin stats --force
          fi
  ```

## What Changed:

The **last step** now:
  1. âœ… Creates/switches to a `stats` branch
  2. âœ… Commits the CONTRIBUTORS.md file there
  3. âœ… Force pushes to `stats` (no conflicts, always fresh)
  4. âœ… **Bypasses your main branch protection** completely!

## How to View Stats:

  **Option 1: Direct link**
  ```
  https://github.com/rayenamer/equa/blob/stats/CONTRIBUTORS.md